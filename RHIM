# Repair 'ipa: ERROR: hostname.domain.com: host not found" errors; WebUI shows server, but deletion fails and host doesn't authenticate
#from IPA server (ep1p-apux07.ux.starkey.com)
ldapsearch -LL -Y GSSAPI -b "dc=ux,dc=starkey,dc=com" > /tmp/starkey.com
view /tmp/starkey.com -> search for hostname to delete, could be multiple entries for same hostname
#entry will look like:
dn: fqdn=ep1t-apcq322.starkey.com+nsuniqueid=7d50ec97-8fca11e6-a090b309-14ffc5de,cn=computers,cn=accounts,dc=ux,dc=starkey,dc=com
#Delete each entry for the hostname in ldap:
ldapdelete -x -D "cn=Directory Manager" -W "dn: fqdn=ep1t-apcq322.starkey.com+nsuniqueid=7d50ec97-8fca11e6-a090b309-14ffc5de,cn=computers,cn=accounts,dc=ux,dc=starkey,dc=com"
# Log into the WebUI and verify the host is gone from the hosts list
# Re-install the IPA Client on the client server
ipa-client-install --uninstall
ipa-client-isntall --domain=UX.STARKEY.COM hostname=hostname.starkey.com --mkhomedir --no-ntp

# Replicas
# https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Identity_Management_Guide/ipa-replica-manage.html
ipa-replica-manage list
ipa-replica-manage force-sync --from ep1p-apux07.ux.starkey.com
ipa-replica-manage re-initialize --from ep1p-apux07.ux.starkey.com

# rngd.service entropy
sudo cp /usr/lib/systemd/system/rngd.service /etc/systemd/system/
sudo vim /etc/systemd/system/rngd.service
 replace :
   ExecStart=/sbin/rngd -f
   with
   ExecStart=/sbin/rngd -f -r /dev/urandom -o /dev/random
sudo systemctl daemon-reload
sudo systemctl start rngd.service

# Add HTTP service to RHIM
on client, configure HTTP application (Apache, cups, etc...) to use KRB5
# CUPS
   vim /etc/cups/cupsd.conf:
      # Default authentication type, when authentication is required
      DefaultAuthType Basic
      Krb5Keytab /etc/cups/cups.keytab
      # Administrator user groups (printeradmin is a local group, printer_admins is in RHIM)
      SystemGroup printeradmin printer_admins

on IPA server, create the service that will provide the authentication mechanism
   ipa service-add HTTP/viking.starkey.com
on client, generate the keytab for the application will use
   ipa-getkeytab -s ep1p-apux07.ux.starkey.com -p HTTP/ep1d-apcups01.starkey.com -k /etc/cups/cups.keytab -e aes256-cts
restart HTTP application

# Enable local authentication if it's not working correctly
authconfig --enablelocauthorize --update

#automate RHIM client add
on IPA server: ipa host-add clienthostname.starkey.com --password=St@rk3y!
in kickstart or on client: /usr/sbin/ipa-client-install --domain=UX.STARKEY.COM --mkhomedir -w St@rk3y! --unattended

# Convert client to 'mkhomedir'
authconfig --enablemkhomedir --update

# Resolve caching issues (force update of sudo)
service sssd stop; rm -f /var/lib/sss/db/*; service sssd start
sss_cache -E

